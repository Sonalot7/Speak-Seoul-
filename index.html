import React, { useState, useMemo } from 'react';
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  Tooltip,
  CartesianGrid,
  PieChart,
  Pie,
  Cell,
  BarChart,
  Bar,
  Legend,
  ResponsiveContainer,
} from 'recharts';

// Single-file React component prototype for GenerateMia Analytics + Simple Planner
// TailwindCSS utility classes are used for styling. This is a protototype — replace mock data
// with real API data and wire up AI endpoints for Mia Chat.

const sampleSubjects = [
  { name: 'Math', weeklyTarget: 6, difficulty: 0.8 },
  { name: 'Physics', weeklyTarget: 4, difficulty: 0.9 },
  { name: 'Korean', weeklyTarget: 5, difficulty: 0.5 },
];

const COLORS = ['#8884d8', '#82ca9d', '#ffc658', '#ff7f50', '#a4de6c'];

export default function GenerateMiaDashboard() {
  const [weeklyHours, setWeeklyHours] = useState(15);
  const [subjects, setSubjects] = useState(sampleSubjects);
  const [studyLog, setStudyLog] = useState(generateMockStudyLog());
  const [plan, setPlan] = useState(generatePlan(weeklyHours, subjects));

  // Recompute plan when inputs change
  const regenerate = () => setPlan(generatePlan(weeklyHours, subjects));

  const hoursBySubject = useMemo(() => {
    const map = {};
    subjects.forEach((s) => (map[s.name] = 0));
    studyLog.forEach((entry) => {
      map[entry.subject] = (map[entry.subject] || 0) + entry.hours;
    });
    return Object.entries(map).map(([name, hours]) => ({ name, hours }));
  }, [studyLog, subjects]);

  const weeklyHoursSeries = useMemo(() => {
    // produce last 7 days series
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    return days.map((d, i) => ({ day: d, hours: Math.round(Math.random() * 3 * (i % 3 + 1) * 10) / 10 }));
  }, [studyLog]);

  return (
    <div className="p-6 min-h-screen bg-slate-50">
      <header className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-semibold">GenerateMia — Analytics & Planner Prototype</h1>
        <div className="space-x-2">
          <button
            onClick={regenerate}
            className="px-4 py-2 bg-indigo-600 text-white rounded shadow-sm hover:bg-indigo-500"
          >
            Regenerate Plan
          </button>
          <button className="px-4 py-2 bg-green-600 text-white rounded shadow-sm hover:bg-green-500">Start Focus Mode</button>
        </div>
      </header>

      <main className="grid grid-cols-12 gap-6">
        {/* Left column: Planner */}
        <section className="col-span-5 bg-white p-4 rounded-lg shadow">
          <h2 className="font-medium mb-3">Quick Planner</h2>
          <div className="mb-4">
            <label className="text-sm block mb-1">Weekly hours available</label>
            <input
              type="range"
              min={5}
              max={40}
              value={weeklyHours}
              onChange={(e) => setWeeklyHours(Number(e.target.value))}
              className="w-full"
            />
            <div className="text-xs text-slate-500 mt-1">{weeklyHours} hours / week</div>
          </div>

          <div className="space-y-3">
            {subjects.map((s, idx) => (
              <div key={s.name} className="flex items-center justify-between">
                <div>
                  <div className="font-semibold">{s.name}</div>
                  <div className="text-xs text-slate-500">Difficulty: {s.difficulty}</div>
                </div>
                <div className="text-right">
                  <div className="text-sm">Target: {s.weeklyTarget}h</div>
                </div>
              </div>
            ))}
          </div>

          <div className="mt-4">
            <h3 className="font-medium mb-2">Generated weekly plan</h3>
            <ul className="space-y-2 text-sm">
              {plan.map((p) => (
                <li key={p.subject} className="flex justify-between">
                  <span>{p.subject}</span>
                  <span className="font-semibold">{p.hours} h</span>
                </li>
              ))}
            </ul>
          </div>
        </section>

        {/* Right column: Analytics */}
        <section className="col-span-7 space-y-6">
          <div className="grid grid-cols-2 gap-6">
            <div className="bg-white p-4 rounded-lg shadow">
              <h3 className="font-medium mb-2">Study Hours (last 7 days)</h3>
              <div style={{ width: '100%', height: 180 }}>
                <ResponsiveContainer>
                  <LineChart data={weeklyHoursSeries}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="day" />
                    <YAxis />
                    <Tooltip />
                    <Line type="monotone" dataKey="hours" stroke="#8884d8" strokeWidth={2} />
                  </LineChart>
                </ResponsiveContainer>
              </div>
            </div>

            <div className="bg-white p-4 rounded-lg shadow">
              <h3 className="font-medium mb-2">Time allocation by subject</h3>
              <div style={{ width: '100%', height: 180 }}>
                <ResponsiveContainer>
                  <PieChart>
                    <Pie data={hoursBySubject} dataKey="hours" nameKey="name" outerRadius={60} label>
                      {hoursBySubject.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
              </div>
            </div>
          </div>

          <div className="bg-white p-4 rounded-lg shadow">
            <h3 className="font-medium mb-2">Accuracy by subject</h3>
            <div style={{ width: '100%', height: 240 }}>
              <ResponsiveContainer>
                <BarChart data={mockAccuracy(subjects)}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="subject" />
                  <YAxis />
                  <Tooltip />
                  <Legend />
                  <Bar dataKey="accuracy" barSize={36} />
                </BarChart>
              </ResponsiveContainer>
            </div>
            <div className="mt-3 text-sm text-slate-600">Insight: You're spending most time on <strong>{hoursBySubject[0]?.name}</strong> but accuracy may be lower than expected — try short targeted quizzes.</div>
          </div>

          <div className="bg-white p-4 rounded-lg shadow">
            <h3 className="font-medium mb-2">Recent Sessions</h3>
            <div className="grid grid-cols-3 gap-3 text-sm">
              {studyLog.slice(0, 6).map((s, i) => (
                <div key={i} className="p-2 border rounded">
                  <div className="font-medium">{s.subject}</div>
                  <div className="text-xs text-slate-500">{s.type} • {s.hours}h</div>
                  <div className="text-xs mt-1">{s.note}</div>
                </div>
              ))}
            </div>
          </div>
        </section>
      </main>

      <footer className="mt-6 text-xs text-slate-500">Prototype • Replace mock logic with real APIs and AI endpoints for Mia Chat.</footer>
    </div>
  );
}

// --- Helpers & mock data ---
function generateMockStudyLog() {
  const items = [];
  const types = ['Focus', 'Revision', 'Practice'];
  for (let i = 0; i < 12; i++) {
    items.push({
      subject: sampleSubjects[i % sampleSubjects.length].name,
      hours: Math.round((Math.random() * 2 + 0.25) * 100) / 100,
      type: types[i % types.length],
      note: 'Quick session: problems & flashcards',
      date: new Date(Date.now() - i * 86400000).toISOString(),
    });
  }
  return items;
}

function generatePlan(weeklyHours, subjects) {
  // Very simple proportional allocation that respects weeklyTarget if provided
  const totalTargets = subjects.reduce((s, x) => s + (x.weeklyTarget || 1), 0);
  return subjects.map((s) => {
    const prop = (s.weeklyTarget || 1) / totalTargets;
    const hours = Math.round(prop * weeklyHours * 10) / 10;
    return { subject: s.name, hours };
  });
}

function mockAccuracy(subjects) {
  return subjects.map((s, i) => ({ subject: s.name, accuracy: Math.round((0.5 + Math.random() * 0.45) * 100) }));
}
